---
title: "Modeling (GLS, LME)"
author: "Hagen Atkeson"
date: "5/12/2021"
output: html_document
---

```{r warning = FALSE, message = FALSE}
library(tidyverse)
library(magrittr)
library(nlme)
library(here)
```

As the timing and number of measurement occasions differ by individual, a linear mixed-effects model would be more suited to the data than a general least squares model. According to the exploratory data analysis, the interaction between treatment and gender, and treatment and age are potentially interesting. Here we shall test if they are needed.
```{r}
#aids <- read_csv(here::here("data/aids.csv"))
aids <- read_csv("~/Documents/Stats-112-Final-Project/data/aids.csv")

aids %<>% 
  mutate(treatment = factor(treatment, levels = c(1, 2, 3, 4)),
         gender = factor(gender, levels = c("male", "female")))

model_rand_interaction <- lme(log_cd4 ~ week + treatment:week + gender:treatment + age:treatment,
                              data = aids,
                              random = ~ week | id,
                              method = "ML")

model_rand <- lme(log_cd4 ~ week,
                  data = aids,
                  random = ~ week | id,
                  method = "ML")

summary(model_rand_interaction)
summary(model_rand)

anova(model_rand, model_rand_interaction)
```
The interaction terms have uneven significance across the treatments. Treatment 2 does not seem to change over time, and only Treatment 4 shows a significant difference in change over time with regard to gender. The ANOVA tests show that the model with the interaction terms is needed and the reduced model is inadequate.


```{r}
aids <- aids %>% 
  mutate(knot_term1 = if_else(week > 10, week, 0)) %>% 
  relocate(knot_term1, .after = week)
```

```{r}
# Linear Mixed Effects Model (linear splines) 
ctrl <- lmeControl(opt='optim')
model_splines <- lme(log_cd4 ~ week + knot_term1,
                     data = aids,
                     random = ~ week + knot_term1| id,
                     method = "ML", 
                     control=ctrl)

summary(model_splines)
anova(model_rand, model_rand_interaction, model_splines)

```

```{r}
aids <- aids %>% 
  mutate(knot_term2 = if_else(week > 20, week, 0)) %>% 
  relocate(knot_term2, .after = knot_term1)
# Linear Mixed Effects Model (linear splines) 
ctrl <- lmeControl(opt='optim')
model_splines2 <- lme(log_cd4 ~ week + knot_term1 + knot_term2,
                     data = aids,
                     random = ~ week + knot_term1 + knot_term2| id,
                     method = "ML", 
                     control=ctrl)

summary(model_splines2)
anova(model_rand, model_rand_interaction, model_splines, model_splines2)
```
```{r}
aids <- aids %>% 
  mutate(knot_term3 = if_else(week > 30, week, 0)) %>% 
  relocate(knot_term3, .after = knot_term2)
# Linear Mixed Effects Model (linear splines) 
ctrl <- lmeControl(opt='optim')
model_splines3 <- lme(log_cd4 ~ week + knot_term1 + knot_term2 + knot_term3,
                     data = aids,
                     random = ~ week + knot_term1 + knot_term2 + knot_term2| id,
                     method = "ML", 
                     control=ctrl)

summary(model_splines3)
anova(model_rand, model_rand_interaction, model_splines, model_splines2, model_splines3)
```


```{r}
aids <- aids %>% 
  mutate(kt1 = if_else(week >= 10 & week<20 , week, 0))
aids <- aids %>% 
  mutate(kt2 = if_else(week >= 20 , week, 0))

model2 <- lme(log_cd4 ~ week + kt1 + kt2 + week:treatment + kt1:treatment + kt2:treatment, 
               data = aids, 
               random = ~ week + kt1 + kt2|id, 
               method = "REML", 
               control = ctrl)
model2_age <- lme(log_cd4 ~ week + kt1 + kt2 + week:treatment + kt1:treatment + kt2:treatment + age:treatment, 
               data = aids, 
               random = ~ week + kt1 + kt2|id, 
               method = "REML", 
               control = ctrl)
summary(model2)
summary(model2_age)

model2_ml <- lme(log_cd4 ~ week + kt1 + kt2 + week:treatment + kt1:treatment + kt2:treatment, 
               data = aids, 
               random = ~ week + kt1 + kt2|id, 
               method = "ML", 
               control = ctrl)
model2_age_ml <- lme(log_cd4 ~ week + kt1 + kt2 + week:treatment + kt1:treatment + kt2:treatment + age:treatment, 
               data = aids, 
               random = ~ week + kt1 + kt2|id, 
               method = "ML", 
               control = ctrl)
anova(model_splines2, model2_ml, model2_age_ml)
```
